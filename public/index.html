<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>School Attendance</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .card {
      background: #fafafa;
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
    }
    button {
      padding: 10px 15px;
      margin: 5px 0;
      background: #0275d8;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button.secondary {
      background: #5a5a5a;
    }
    input {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 8px;
      border: 1px solid #bbb;
      border-radius: 5px;
    }
    .small {
      font-size: 14px;
      color: #444;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>School Attendance System</h2>

    <!-- QR Card -->
    <div class="card">
      <strong>1. Scan QR or Enter QR Token</strong>
      <input id="qrToken" placeholder="Enter QR token (e.g., tk_stu_0001)" />
      <button id="sendQRBtn">Submit QR Attendance</button>
      <div id="qrStatus" class="small"></div>
    </div>

    <!-- PIN Card -->
    <div class="card">
      <strong>2. Enter PIN</strong>
      <input id="pinInput" placeholder="Enter PIN (1234)" type="password" />
      <button id="pinBtn">Submit PIN Attendance</button>
      <div id="pinStatus" class="small"></div>
    </div>

    <!-- VOICE Card -->
    <div class="card">
      <strong>3. Voice verification</strong>
      <button id="enrollVoiceBtn" class="secondary">ðŸŽ™ Enroll Voice</button>
      <button id="checkVoiceBtn" class="secondary">ðŸŽ™ Check Voice</button>
      <div id="voiceStatus" class="small"></div>
    </div>

    <!-- ADMIN PANEL -->
    <div class="card">
      <strong>Admin / Principal</strong>
      <p class="small">
        <a href="/voices.html" target="_blank">Open Voice Review Page</a>
      </p>
    </div>
  </div>

<script>
const API = "https://school-attendance-backend-3kw6.onrender.com"; 

// QR Attendance
document.getElementById("sendQRBtn").onclick = async () => {
  const qr = document.getElementById("qrToken").value.trim();

  const res = await fetch(API + "/api/device/event", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-device-key": "devkey123"
    },
    body: JSON.stringify({
      device_id: "web-qr",
      events: [
        { token_or_pin: qr, method: "qr", timestamp: new Date().toISOString() }
      ]
    })
  });

  const data = await res.json();
  document.getElementById("qrStatus").textContent = JSON.stringify(data);
};

// PIN Attendance
document.getElementById("pinBtn").onclick = async () => {
  const pin = document.getElementById("pinInput").value.trim();

  const res = await fetch(API + "/api/device/event", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-device-key": "devkey123"
    },
    body: JSON.stringify({
      device_id: "web-pin",
      events: [
        { token_or_pin: pin, method: "pin", timestamp: new Date().toISOString() }
      ]
    })
  });

  const data = await res.json();
  document.getElementById("pinStatus").textContent = JSON.stringify(data);
};

// Voice recording helper
async function recordAudio(seconds = 3) {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const mediaRecorder = new MediaRecorder(stream);
  let chunks = [];

  return new Promise(resolve => {
    mediaRecorder.ondataavailable = e => chunks.push(e.data);

    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: "audio/webm" });
      stream.getTracks().forEach(t => t.stop());
      resolve(blob);
    };

    mediaRecorder.start();
    setTimeout(() => mediaRecorder.stop(), seconds * 1000);
  });
}

// Voice Enroll
document.getElementById("enrollVoiceBtn").onclick = async () => {
  const studentId = document.getElementById("qrToken").value.trim();
  if (!studentId) return alert("Scan QR token first");

  const audio = await recordAudio(3);

  const form = new FormData();
  form.append("audio", audio, "enroll.webm");
  form.append("student_id", studentId);
  form.append("type", "enroll");

  const res = await fetch(API + "/api/voice/enroll", { method: "POST", body: form });
  const data = await res.json();

  document.getElementById("voiceStatus").textContent =
    "Enroll saved: " + data.file;
};

// Voice Check
document.getElementById("checkVoiceBtn").onclick = async () => {
  const studentId = document.getElementById("qrToken").value.trim();
  if (!studentId) return alert("Scan QR token first");

  const audio = await recordAudio(3);

  const form = new FormData();
  form.append("audio", audio, "check.webm");
  form.append("student_id", studentId);
  form.append("type", "check");

  const res = await fetch(API + "/api/voice/check", { method: "POST", body: form });
  const data = await res.json();

  document.getElementById("voiceStatus").textContent =
    "Check saved: " + data.file;
};
</script>

</body>
</html>

